<!doctype html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<meta http-equiv="Content-Language" content="fr">
<title>Shift QR Generator</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<style>
body{
  background:#050a18;
  color:#e7eefc;
  font-family:Arial, sans-serif;
  padding:20px;
}
h2{margin-bottom:10px}
button{
  background:#4b7bff;
  color:#fff;
  border:0;
  border-radius:10px;
  padding:8px 12px;
  cursor:pointer;
  font-weight:600;
}
.secondary{background:#27355f}
#shifts{max-width:900px}
.shift{
  background:#0f1933;
  border:1px solid #1f2b4a;
  border-radius:14px;
  padding:14px;
  margin-bottom:12px;
  cursor:grab;
}
.shift.dragging{opacity:.4}
.row{display:flex;gap:8px;margin-bottom:8px}
input{
  background:#070c1a;
  border:1px solid #2b3a61;
  border-radius:10px;
  padding:8px;
  color:#fff;
  width:100%;
}
img{
  width:170px;
  height:170px;
  background:#fff;
  border-radius:10px;
  padding:6px;
}
.small{font-size:12px;opacity:.8}
.code{
  font-family:ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, monospace;
}
</style>
</head>

<body>

<h2>Shift QR Generator</h2>
<button onclick="addShift()">➕ Ajouter un shift</button>

<div id="shifts"></div>

<script>
/* ================== CONFIG ================== */
const STORAGE_KEY = "cmh_shifts_saved_text_qr";
const shiftsEl = document.getElementById("shifts");
let dragEl = null;

/* ================== HELPERS ================== */
function randToken(len=6){
  const c="ABCDEFGHJKLMNPQRSTUVWXYZ23456789";
  let o="";
  for(let i=0;i<len;i++) o+=c[Math.floor(Math.random()*c.length)];
  return o;
}
function dateForCode(d){ return d.replaceAll("-",""); } // 2025-12-24 → 20251224
function dateForDisplay(d){
  const [y,m,dd]=d.split("-");
  return `${dd}/${m}/${y}`; // 24/12/2025
}
function buildCode(date, group){
  return `CMH-${dateForCode(date)}-G${group}-${randToken()}`;
}
function qrURLText(text){
  return "https://api.qrserver.com/v1/create-qr-code/?size=240x240&data="
    + encodeURIComponent(text);
}
function shiftFileName(group, date, start, end){
  const [y,m,d] = date.split("-");
  const dateFR = `${d}-${m}-${y}`;
  const startFR = start.replace(":", "h");
  const endFR   = end.replace(":", "h");
  return `Shift_Groupe${group}_${dateFR}_${startFR}-${endFR}.png`;
}

/* ================== STORAGE ================== */
function save(){
  const data=[...shiftsEl.children].map(card=>{
    const i=card.querySelectorAll("input");
    return {
      group:i[0].value,
      date:i[1].value,
      start:i[2].value,
      end:i[3].value,
      code:i[4].value
    };
  });
  localStorage.setItem(STORAGE_KEY, JSON.stringify(data));
}
function load(){
  const data = JSON.parse(localStorage.getItem(STORAGE_KEY) || "[]");
  data.forEach(s => shiftsEl.appendChild(createShift(s)));
}

/* ================== SHIFT CARD ================== */
function createShift(data={}){
  const div=document.createElement("div");
  div.className="shift";
  div.draggable=true;

  div.innerHTML=`
    <div class="row">
      <input placeholder="Groupe" value="${data.group || '7'}">
      <input type="date" value="${data.date || ''}">
    </div>
    <div class="row">
      <input type="time" value="${data.start || '09:00'}">
      <input type="time" value="${data.end || '17:00'}">
    </div>
    <div class="row">
      <input class="code" readonly value="${data.code || ''}">
      <button class="secondary gen">QR</button>
      <button class="secondary dl">⬇ Télécharger</button>
    </div>
    <div class="row">
      <img alt="QR">
      <div class="small">Drag ↑ ↓</div>
    </div>
  `;

  const i = div.querySelectorAll("input");
  const img = div.querySelector("img");

  function generate(){
    if(!i[1].value) return alert("Veuillez choisir une date");
    if(!i[4].value) i[4].value = buildCode(i[1].value, i[0].value);

    const text =
`CMH SHIFT
Group: ${i[0].value}
Date: ${dateForDisplay(i[1].value)}
Shift: ${i[2].value} → ${i[3].value}
Code: ${i[4].value}`;

    img.src = qrURLText(text);
    save();
  }

  async function downloadQR(){
    if(!img.src){
      alert("Generate QR first");
      return;
    }
    try{
      const res = await fetch(img.src);
      const blob = await res.blob();
      const url = URL.createObjectURL(blob);

      const filename = shiftFileName(
        i[0].value,
        i[1].value,
        i[2].value,
        i[3].value
      );

      const a = document.createElement("a");
      a.href = url;
      a.download = filename;
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);
    }catch(e){
      console.error(e);
      alert("Download failed ❌");
    }
  }

  div.querySelector(".gen").onclick = generate;
  div.querySelector(".dl").onclick = downloadQR;

  // Save on change
  i.forEach(inp => inp.onchange = () => save());

  /* Drag & Drop */
  div.addEventListener("dragstart",()=>{
    dragEl = div;
    div.classList.add("dragging");
  });
  div.addEventListener("dragend",()=>{
    dragEl = null;
    div.classList.remove("dragging");
    save();
  });
  div.addEventListener("dragover",e=>{
    e.preventDefault();
    const cards=[...shiftsEl.querySelectorAll(".shift:not(.dragging)")];
    const after = cards.find(c=>{
      const r=c.getBoundingClientRect();
      return e.clientY < r.top + r.height/2;
    });
    if(after) shiftsEl.insertBefore(dragEl, after);
    else shiftsEl.appendChild(dragEl);
  });

  // Auto-generate if loaded data
  if(data.date){
    if(!data.code) i[4].value = buildCode(i[1].value, i[0].value);
    generate();
  }

  return div;
}

/* ================== MAIN ================== */
function addShift(){
  shiftsEl.appendChild(createShift());
  save();
}

/* INIT */
load();
if(!shiftsEl.children.length) addShift();
</script>

</body>
</html>
